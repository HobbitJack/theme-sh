#!/usr/bin/sh

COMMENT="#"

if [ -z "$1" ] || [ "$1" = "-h" ] || [ "$1" = "--help" ] || [ "$1" = "-?" ]
then
	echo "Usage: theme-sh [-c|--comment-char CHAR] [-d|--delimiter-char CHAR] PROGNAME [RESOURCE]"
	echo "Usage: theme-sh -s|--system"
	echo "Usage: theme-sh [-h|-v|--help|--version]"
	echo "Install theme for PROGNAME to RESOURCE (default: ~/.Xresources), or theme whole system"
	echo
	echo "  -c, --comment-char=CHAR     use comment char CHAR; no CHAR for no comments"
	echo "  -d, --delimiter-char=CHAR   use delimiter CHAR instead of whitespace"
	echo "  -h, --help                  output this help and exit"
	echo "  -v, --version               output version and exit"
	echo
	echo "For full documentation, try 'man theme-sh'"
	exit
fi

if [ "$1" = "-v" ] || [ "$1" = "--version" ] || [ "$1" = "-V" ]
then
	echo "theme-sh v1.1.0"
	echo "Copyright (C) 2025 Jack Renton Uteg"
	echo "Written by Jack R. Uteg"
	exit
fi

if [ "$1" = "-s" ] || [ "$1" = "--system" ]
then
	if [ ! -d "$HOME/.local/etc/theme/" ]
	then
		echo "${0}: no theme directory"
		exit 1
	fi
	
	for program in "$HOME/.local/etc/theme"/*
	do
		if [ ! -f "$program" ]
		then
			continue
		fi
		OPS=$(head -n1 "$HOME/.local/etc/theme/$(basename "$program")" | sed -n '/#!#*/p' | sed 's/#!#//')
		COMMENT=$(echo "$OPS" | cut -f1)
		DELIMITER=$(echo "$OPS" | cut -f2)
		TARGET=$(echo "$OPS" | cut -f3 | sed "s:^~:$HOME:")
		[ -n "$COMMENT" ] && COMMENT="-c $COMMENT"
		[ -n "$DELIMITER" ] && DELIMITER="-d $DELIMITER"		
		theme-sh $COMMENT $DELIMITER "$(basename "$program")" "$TARGET"
	done

	exit 0
fi

if [ "$1" = "-c" ] || [ "$1" = "--comment-char" ]
then
	COMMENT="$2"
	shift 2
fi

if [ "$1" = "-d" ] || [ "$1" = "--delimiter-char" ]
then
	DELIMITER="$2"
	shift 2
fi

if [ -f "$HOME/.local/etc/theme/${1}" ]
then
	THEME="$HOME/.local/etc/theme/${1}"
elif [ -f "/etc/theme/${1}" ]
then
	THEME="/etc/theme/${1}"
else
	echo "${0}: ${1}: no such theme"
	exit 1
fi

SED=$(echo "$1" | cat - "$THEME" | sed '/#!#*/d' | sed 's/\[/\\[/g' | sed 's/]/\]/g' | awk "BEGIN {ORS=\"\"; FS=\"${DELIMITER:- }\"} NR == 1 {print \"/AUTOGENERATED BY theme-sh FOR \" \$0 \"/d;\"} NR != 1 {print\"/\" \$1 \"/d;\"} END {printf \"\n\"}" | sed 's/\*/\\*/g')

if [ -z "$2" ]
then
	TARGET="$HOME/.Xresources"
else
	TARGET="$(dirname "$2")/$(basename "$2")"
fi

sed -i -e "$SED" "$TARGET" 
if [ -n "$COMMENT" ]
then
	echo "${COMMENT}${COMMENT} AUTOGENERATED BY theme-sh FOR ${1} ${COMMENT}${COMMENT}" >> "$TARGET"
fi
cat ~/.cache/wal/colors ~/.cache/wal/wal | awk 'NR < 17 {print "define(COLOR" NR-1 ",`" toupper($0) "'\'')dnl"} NR == 17 {print "define(WALLPAPER,`" $0 "'\'')dnl"}' | cat - "$THEME" | sed '/#!#*/d' | m4 >> "$TARGET"
